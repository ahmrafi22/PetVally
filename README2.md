#  Guide
## Overview of the Flow

- **Fetching Posts**: The app fetches missing pet posts (all posts or local ones) via an API.
- **Displaying Posts**: Fetched data is shown in the UI using React’s `.map` function.
- **Creating Posts**: Users can report a missing pet via a form, which sends data to the API and database.
- **Database Functions**: Prisma handles all database operations like fetching and creating posts.


## Authentication 
The authentication token is saved in localstorage when any user is logged in by `localStorage.setItem("userToken", data.token)` in the login page . This token is generated by `jose` in `auth.ts` file

And verified in api , so we have to send the token when calling api , 

```
const token = localStorage.getItem("userToken");
````

## 1. Fetching Posts

### How the API is Called

The app uses the `/api/users/missingposts` endpoint to fetch posts.

#### Two Types of Fetches:

- **All Posts**: A simple `GET` request to `/api/users/missingposts`.
- **Local Posts**: Adds query parameters `city` and `area` (e.g., `/api/users/missingposts?city=New York&area=Manhattan`).

A JWT token is sent in the `Authorization` header for authentication.

#### Snippet (Fetching Posts in `page.tsx`):

```tsx
const response = await fetch("/api/users/missingposts", {
  headers: { Authorization: `Bearer ${token}` },
});
const data = await response.json();
setAllPosts(data.posts);

// for getting the post near you 
      if (userData.city && userData.area) {
        const localResponse = await fetch(
          `/api/users/missingposts?city=${encodeURIComponent(
            userData.city
          )}&area=${encodeURIComponent(userData.area)}`,
          {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }

          if (localResponse.ok) {
          const localData = await localResponse.json();
          setLocalPosts(localData.posts);
        } else {
          console.error("Failed to fetch local posts");
          setLocalPosts([]);
        }
        );
```

### Dummy Data Returned

Here’s an example of what the API might return in JSON format:

```json
[
  {
    "id": "1",
    "title": "Missing Labrador",
    "description": "Last seen in Central Park",
    "images": "https://example.com/lab.jpg",
    "country": "USA",
    "city": "new york",
    "area": "manhattan",
    "species": "Dog",
    "breed": "Labrador",
    "age": 3,
    "status": "NOT_FOUND",
    "upvotesCount": 5,
    "user": { "id": "user1", "name": "John Doe" },
    "_count": { "comments": 2, "upvotes": 5 },
    "createdAt": "2023-10-01T12:00:00Z"
  },
  {
    "id": "2",
    "title": "Missing Siamese Cat",
    "description": "Last seen near the library",
    "images": "https://example.com/cat.jpg",
    "city": "new york",
    "area": "brooklyn",
    "species": "Cat",
    "breed": "Siamese",
    "age": 2,
    "status": "NOT_FOUND",
    "upvotesCount": 3
  }
]
```

For local posts (`city=New York&area=Manhattan`), only the first post would be returned since it matches the location.

---

## 2. Displaying Posts

### How Data is Shown

The fetched data is stored in React state variables:

- `allPosts`: Stores all missing posts.
- `localPosts`: Stores posts in the user’s area (if city/area are set).

The `.map` function loops through these arrays to display each post as a card.

#### Snippet (Rendering Posts in `page.tsx`):

```tsx
<div className="space-y-4">
  {allPosts.map((post) => renderPostCard(post))}
</div>
```

`renderPostCard` is a function that takes a post object and returns JSX to display its details (title, description, image, etc.).

### React State and Effects

- **State**: `useState` manages `allPosts`, `localPosts`, `loading`, and `error` to control what the UI shows.
- **Effect**: `useEffect` triggers the `fetchPosts` function when the page loads or when user data changes.

#### Snippet (State and Effect):

```tsx
const [allPosts, setAllPosts] = useState([]);
useEffect(() => {
  if (!userLoading) fetchPosts();
}, [userData, userLoading]);
```

### Zustand Store ( this stores user data as a global variable useable anywhere )

A Zustand store (`useUserStore`) holds user data like city and area. This is used to fetch local posts.

#### Snippet (Zustand Store):

```tsx
export const useUserStore = create((set) => ({
  userData: { id: '', name: '', city: '', area: '' },
  fetchUserData: async () => { /* Fetch logic */ },
}));
```

---

## 3. Database Functions

### How They Work

The app uses Prisma to interact with the database. Key functions include:

- `getAllMissingPosts`: Fetches all posts with user info and counts (comments, upvotes).
- `getMissingPostsInArea`: Fetches posts matching a city and area (case-insensitive).
- `createMissingPost`: Creates a new post and uploads the image to Cloudinary.

#### Snippet (Fetching Posts from DB):

```ts
export async function getAllMissingPosts() {
  return await prisma.missingPost.findMany({
    include: { user: { select: { id: true, name: true } } },
    orderBy: { createdAt: "desc" },
  });
}
```

These functions are called by the API handlers and return data to the frontend.

---

## 4. Creating a New Post

### What Happens When "Create Post" is Clicked

Clicking the "Report Missing Pet" button opens a dialog by setting `createPostOpen` to `true`.

#### Snippet (Button Click):

```tsx
<Button onClick={() => setCreatePostOpen(true)}>
  Report Missing Pet
</Button>
```

### How Forms are Handled

The `CreateMissingPostDialog` component contains a form with fields (title, description, image, etc.).

- **State**: `formData` stores the input values, and `previewImage` holds the uploaded image as a base64 string.
- **Validation**: Checks for invalid characters in the area field (e.g., no hyphens).
- **Image Upload**: Users upload an image, which is previewed before submission.

#### Snippet (Form Handling):

```tsx
const handleInputChange = (e) => {
  setFormData((prev) => ({ ...prev, [e.target.name]: e.target.value }));
};
```

### Submitting the Form

On submit, the form data (including the base64 image) is sent to the API via a `POST` request to `/api/users/missingposts`.

#### Snippet (Form Submission):

```tsx
const response = await fetch("/api/users/missingposts", {
  method: "POST",
  body: JSON.stringify({ ...formData, imageBase64: previewImage }),
});
```

#### Dummy Data Sent to API

```json
{
  "title": "Missing Golden Retriever",
  "description": "Last seen at the beach",
  "imageBase64": "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
  "country": "USA",
  "city": "Los Angeles",
  "area": "Santa Monica",
  "species": "Dog",
  "breed": "Golden Retriever",
  "age": 4
}
```

---

## 5. API Methods

### GET `/api/users/missingposts`

- **Logic**: Checks the token, then calls `getAllMissingPosts` or `getMissingPostsInArea` based on query params.
- **Response**: Returns posts in JSON (see dummy data above).

#### Snippet (API GET):

```ts
if (city && area) {
  posts = await getMissingPostsInArea(city, area);
} else {
  posts = await getAllMissingPosts();
}
return NextResponse.json({ message: "Success", posts });
```

### POST `/api/users/missingposts`

- **Logic**: Verifies the token, validates fields, and calls `createMissingPost`.
- **Response**: Returns the created post in JSON.

#### Snippet (API POST):

```ts
const post = await createMissingPost(userId, body);
return NextResponse.json({ message: "Post created", post }, { status: 201 });
```

#### Dummy Response from POST

```json
{
  "message": "Missing post created successfully",
  "post": {
    "id": "3",
    "title": "Missing Golden Retriever",
    "images": "https://cloudinary.com/retriever.jpg",
    "city": "los angeles",
    "area": "santa monica"
  }
}
```

---

## 6. Creating a New Post in the Backend

### Steps in `createMissingPost`

- **Image Upload**: The base64 image is uploaded to Cloudinary, returning a URL.
- **Database Insert**: The post is created with the image URL and other form data.
- **Notifications**: Users in the same area are notified about the new post.

#### Snippet (Creating Post):

```ts
const uploadResponse = await uploadImage(data.imageBase64, "missing_posts");
const post = await prisma.missingPost.create({
  data: { title: data.title, images: uploadResponse.secure_url, ... },
});
```

### Notifications

Finds users in the same city/area and sends them a notification.

#### Snippet (Notifications):

```ts
const matchingUsers = usersInArea.filter(user =>
  user.city.toLowerCase() === data.city.toLowerCase()
);
await createNotificationForUsers(userIds, "NEW_MISSING_POST", `Missing pet: ${data.title}`);
```

---

## Summary

- **API**: Handles GET (fetch posts) and POST (create posts) with token authentication.
- **UI**: Uses `.map` to display posts, managed by React state and effects.
- **Database**: Prisma functions fetch and store data efficiently.
- **Creating Posts**: A dialog collects data, sends it to the API, and updates the UI on success.

This feature ties together frontend, backend, and database seamlessly to help users report and find missing pets!

